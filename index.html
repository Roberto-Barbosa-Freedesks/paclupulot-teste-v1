<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Pac-L√∫pulo da Cervejaria CAMPINAS</title>
    <meta name="description" content="Jogue Pac-L√∫pulo, o jogo oficial da Cervejaria Campinas! Colete l√∫pulos, evite os fantasmas e conquiste o ranking cervejeiro." />
    <meta name="keywords" content="pac-man, cervejaria campinas, jogo, l√∫pulo, cerveja, ranking" />
    <meta name="author" content="Cervejaria Campinas" />
    
    <!-- Performance and Mobile Optimization -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover" />
    <meta name="theme-color" content="#f5d922" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://www.gstatic.com" />
    <link rel="preconnect" href="https://servicodados.ibge.gov.br" />
    <link rel="preconnect" href="https://viacep.com.br" />
    
    <!-- Icons and Manifest -->
    <link rel="apple-touch-icon-precomposed" href="icon/ios_icon.png" />
    <link rel="icon" type="image/png" href="icon/favicon.png" />
    
    <!-- Preload critical resources -->
    <link rel="preload" href="font/ARCADE_R.TTF" as="font" type="font/ttf" crossorigin />
    <link rel="preload" href="img/capa.jpg" as="image" />
    <link rel="preload" href="sounds/coffee-break-music.mp3" as="audio" />

    <style>
      /* Reset and Base Styles */
      * {
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        padding: 0;
        background: #000;
        font-family: var(--primary-font);
        overflow: hidden;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* üéÆ FONTE ARCADE PERFEITA - Press Start 2P */
      /* Escolhida pela equipe de especialistas para m√°ximo impacto visual */
      @font-face {
        font-family: 'PressStart2P';
        src: url('font/PressStart2P.ttf') format('truetype');
        font-display: swap;
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD, U+00C0-00FF;
      }
      
      /* Font stack otimizado para jogos arcade/retro */
      :root {
        --primary-font: 'PressStart2P', 'Roboto', 'Monaco', 'Consolas', monospace;
        --fallback-font: 'PressStart2P', monospace;
      }
      
      /* üé® Renderiza√ß√£o otimizada para Press Start 2P */
      * {
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        font-variant-ligatures: none;
      }
      
      /* üéÆ Garantia de Press Start 2P para todos os textos arcade */
      body, h1, h2, h3, .title, .menu-title, .accent-text {
        font-family: var(--primary-font) !important;
        font-weight: normal; /* Press Start 2P √© naturalmente bold */
        letter-spacing: 1px; /* Espa√ßamento arcade cl√°ssico */
      }
      
      /* üåü Otimiza√ß√µes de contraste e legibilidade para Press Start 2P */
      .arcade-text {
        text-shadow: 
          -1px -1px 0 #000,
          1px -1px 0 #000,
          -1px 1px 0 #000,
          1px 1px 0 #000,
          0 0 5px rgba(245, 217, 34, 0.3);
        color: #f5d922;
      }
      
      /* T√≠tulos principais com m√°ximo impacto visual */
      .main-title {
        font-size: clamp(18px, 5vw, 32px);
        text-shadow: 
          -2px -2px 0 #000,
          2px -2px 0 #000,
          -2px 2px 0 #000,
          2px 2px 0 #000,
          0 0 10px rgba(245, 217, 34, 0.5);
        color: #f5d922;
        letter-spacing: 2px;
      }
      
      /* Canvas Warning */
      #canvas-warning {
        color: #ff0;
        font-size: 1.5em;
        text-align: center;
        padding: 20px;
      }

      /* Animations */
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
      
      /* Loading Spinner */
      .loading-spinner {
        border: 3px solid #333;
        border-top: 3px solid #f5d922;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Button Styles */
      .btn--secondary { filter: saturate(0.9) contrast(1.05); }
      .btn {
        padding: 12px 24px;
        margin: 8px;
        background: linear-gradient(145deg, #f5d922, #e6c41d);
        color: #000;
        border: none;
        border-radius: 8px;
        font-family: inherit;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        text-transform: uppercase;
      }
      
      .btn:hover {
        background: linear-gradient(145deg, #e6c41d, #d4b01a);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.4);
      }
      
      .btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }
      
      /* Input Styles */
      .locked { opacity: 0.8; background:#1c1c1c; }
      .form-input {
        display: block;
        width: 90%;
        margin: 10px 0;
        padding: 12px;
        border: 2px solid #333;
        border-radius: 4px;
        background: #222;
        color: #fff;
        font-family: inherit;
        font-size: 12px;
        transition: border-color 0.3s ease;
      }
      
      .form-input:focus {
        outline: none;
        border-color: #f5d922;
        box-shadow: 0 0 0 2px rgba(245, 217, 34, 0.2);
      }
      
      .form-input::placeholder {
        color: #888;
      }
      
      /* Top Buttons */
      #pontos-button, #logout-button {
        position: fixed;
        top: 15px;
        z-index: 2001;
        padding: 6px 10px;
        font-size: 7px;
        font-family: inherit;
        background: rgba(34, 34, 34, 0.95);
        color: #fff;
        border: 2px solid #f5d922;
        border-radius: 3px;
        cursor: pointer;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
      }
      
      #pontos-button { right: 90px; }
      #logout-button { right: 15px; }
      
      #pontos-button:hover, #logout-button:hover {
        background: rgba(245, 217, 34, 0.2);
        transform: translateY(-2px);
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          font-size: 11px;
        }
        
        #pontos-button, #logout-button {
          font-size: 9px;
          padding: 7px 11px;
          top: 10px;
        }
        
        #pontos-button { right: 80px; }
        #logout-button { right: 10px; }
        
        .btn {
          padding: 10px 20px;
          font-size: 12px;
        }
        
        .form-input {
          padding: 10px;
          font-size: 12px;
        }
        
        /* Melhor experi√™ncia em telas pequenas */
        #auth-screen > div {
          max-width: 350px;
          padding: 30px 20px;
        }
        
        #pontos-screen > div {
          max-width: 350px;
          padding: 20px 15px;
        }
        
        /* Canvas responsivo */
        #canvas {
          max-width: 100vw;
          max-height: 70vh;
          object-fit: contain;
        }
        
        /* Ajustes para notifica√ß√µes mobile */
        #notification-container {
          top: 60px;
          right: 10px;
          left: 10px;
          max-width: none;
        }
        
        /* Melhoria na grid de pontos */
        #pontos-screen .grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
      }
      
      @media (max-width: 480px) {
        #start-wrapper {
          width: 95vw;
        }
        
        #start-text {
          font-size: clamp(14px, 3.5vw, 20px);
        }
        
        #auth-screen > div,
        #pontos-screen > div {
          width: 95%;
          padding: 20px 15px;
        }
        
        .btn {
          padding: 8px 16px;
          font-size: 11px;
        }
        
        .form-input {
          padding: 8px;
          font-size: 11px;
        }
        
        /* Bot√µes de controle menores em telas muito pequenas */
        #pontos-button, #logout-button {
          font-size: 9px;
          padding: 6px 10px;
        }
      }
      
      /* Orienta√ß√£o landscape em mobile */
      @media (max-width: 768px) and (orientation: landscape) {
        #canvas {
          max-height: 85vh;
        }
        
        #pontos-button, #logout-button {
          top: 5px;
        }
        
        #notification-container {
          top: 40px;
        }
      }
      
      /* Melhorias para touch */
      @media (hover: none) and (pointer: coarse) {
        .btn, .form-input, #pontos-button, #logout-button {
          min-height: 44px; /* Tamanho m√≠nimo recomendado para touch */
        }
        
        .btn:active {
          transform: scale(0.95);
        }
        
        /* Remove hover effects em dispositivos touch */
        .btn:hover {
          transform: none;
          box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
      }
      
      /* Accessibility */
      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
      
      /* High contrast mode */
      @media (prefers-contrast: high) {
        .btn {
          border: 2px solid #fff;
        }
        
        .form-input {
          border: 2px solid #fff;
        }
      }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
      // Configura√ß√£o do Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDg_PZ01MsdfWK8dlVKO78T_L8IRQTN6Pw",
        authDomain: "cervejariacampinas-paclupulo.firebaseapp.com",
        projectId: "cervejariacampinas-paclupulo",
        storageBucket: "cervejariacampinas-paclupulo.appspot.com",
        messagingSenderId: "530428991490",
        appId: "1:530428991490:web:eb107a3bae413d6fdf2f1b",
        measurementId: "G-CBG0XB27WQ",
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const functions = firebase.functions();

      // Habilita o ‚Äúmodo lembrar usu√°rio‚Äù (persistence LOCAL)
      firebase
        .auth()
        .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => console.log("Persist√™ncia LOCAL ativada"))
        .catch((err) =>
          console.error("Erro ao definir persist√™ncia:", err.message),
        );
    </script>

    <script>
      // 1) Fun√ß√£o para carregar estados do IBGE
      function carregarEstados() {
        fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados")
          .then((response) => response.json())
          .then((estados) => {
            estados.sort((a, b) => (a.sigla > b.sigla ? 1 : -1));
            const selectEstado = document.getElementById("register-state");
            // Limpa qualquer <option> pr√©-existente (exceto o placeholder)
            selectEstado
              .querySelectorAll('option:not([value=""])')
              .forEach((opt) => opt.remove());
            estados.forEach((estado) => {
              const opt = document.createElement("option");
              opt.value = estado.sigla; // ex: "SP"
              opt.textContent = `${estado.sigla} - ${estado.nome}`; // ex: "SP - S√£o Paulo"
              opt.setAttribute("data-id", estado.id); // ID IBGE necess√°rio para buscar munic√≠pios
              selectEstado.appendChild(opt);
            });
          })
          .catch((err) => {
            console.error("Erro ao carregar estados:", err);
          });
      }

      // 2) Fun√ß√£o para carregar cidades de um estado selecionado
      function carregarCidades(ufId) {
        const datalistCidade = document.getElementById("register-city-list");
        datalistCidade.innerHTML = ""; // Limpa op√ß√µes anteriores
        if (!ufId) return;
        fetch(
          `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${ufId}/municipios`,
        )
          .then((response) => response.json())
          .then((cidades) => {
            cidades.sort((a, b) => (a.nome > b.nome ? 1 : -1));
            cidades.forEach((cidade) => {
              const opt = document.createElement("option");
              opt.value = cidade.nome; // ex: "Campinas"
              datalistCidade.appendChild(opt);
            });
          })
          .catch((err) => {
            console.error("Erro ao carregar cidades:", err);
          });
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Carrega listagem de estados ao carregar a p√°gina
        carregarEstados();
        // Quando o usu√°rio muda o estado, carrega as cidades correspondentes
        const selectEstado = document.getElementById("register-state");
        if (selectEstado) {
          selectEstado.addEventListener("change", function () {
            const idx = selectEstado.selectedIndex;
            const optSelecionada = selectEstado.options[idx];
            const ufId = optSelecionada.getAttribute("data-id");
            carregarCidades(ufId);
          });
        }
      });
    </script>
  
    <style>
      /* Acessibilidade: foco vis√≠vel em bot√µes fixos do topo */
      #pontos-button:focus-visible, #logout-button:focus-visible {
        outline: 3px solid #f5d922;
        outline-offset: 2px;
      }
      /* Respeita usu√°rios com prefer√™ncia por menos anima√ß√£o */
      @media (prefers-reduced-motion: reduce) {
        * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; }
      }
    </style>

  </head>

  <body>
    <!-- Fonte custom para a classe ArcadeR -->
    <div style="font-family: &quot;ArcadeR&quot;"></div>

    <!-- ========== √ÅUDIO DE FUNDO (loop) ========== -->
    <audio id="bg-music" src="sounds/coffee-break-music.mp3" loop aria-hidden="true"></audio>
    <!-- =============================================== -->

    <!-- ========== TELA START ========== -->
    <div
      id="start-screen"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #000 0%, #111 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1002;
        animation: fadeIn 0.5s ease-out;
      "
    >
      <div
        id="start-wrapper"
        style="
          position: relative; 
          width: 90vw; 
          max-width: 448px;
          animation: pulse 2s ease-in-out infinite;
        "
      >
        <img
          src="img/capa.jpg"
          alt="Pac-L√∫pulo da Cervejaria Campinas"
          style="
            display: block; 
            width: 100%; 
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(245, 217, 34, 0.3);
          "
          loading="eager"
        />
        <p
          id="start-text"
          style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            font-family: var(--primary-font);
            font-size: clamp(16px, 4vw, 24px);
            color: #f5d922;
            text-shadow:
              -2px -2px 0 #000,
              2px -2px 0 #000,
              -2px 2px 0 #000,
              2px 2px 0 #000,
              0 0 10px rgba(245, 217, 34, 0.5);
            animation: blink 1s steps(1) infinite;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
          "
        >
          TOQUE PARA JOGAR
        </p>
      </div>
    </div>
    <!-- ========== FIM TELA START ========== -->

    <!-- === TELA DE AUTENTICA√á√ÉO (LOGIN / CADASTRO) === -->
    <div
      id="auth-screen"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease-out;
      "
    >
      <!-- Formul√°rio de Login -->
      <div
        id="login-form"
        style="
          background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
          padding: 40px;
          border-radius: 16px;
          border: 2px solid #f5d922;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 40px rgba(0,0,0,0.5);
          animation: fadeIn 0.5s ease-out;
        "
      >
        <h2 style="color: #f5d922; margin-bottom: 30px; font-size: 20px;">JOGAR PAC-L√öPULO</h2>
        <div id="login-loading" class="loading-spinner" style="display: none;"></div>
        <p id="login-error" style="color: #ff4444; min-height: 20px; margin-bottom: 20px;"></p>
        <input
          type="email"
          id="login-email"
          placeholder="Seu Email"
          class="form-input"
          required
        />
        <input
          type="password"
          id="login-password"
          placeholder="Sua Senha"
          class="form-input"
          required
        />
        <button
          id="login-button"
          class="btn"
          style="width: 100%; margin-top: 20px;"
        >
          Entrar
        </button>
        <p style="margin-top: 30px; color: #ccc; font-size: 14px;">
          N√£o tem conta ainda?
          <a
            href="#"
            id="show-register-link"
            style="color: #f5d922; cursor: pointer; text-decoration: none; font-weight: bold;"
          >
            Cadastre-se aqui!
          </a>
        </p>
      </div>

      <!-- Formul√°rio de Cadastro -->
      <div
        id="register-form"
        style="
          background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
          padding: 40px;
          border-radius: 16px;
          border: 2px solid #f5d922;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 40px rgba(0,0,0,0.5);
          display: none;
          animation: fadeIn 0.5s ease-out;
        "
      >
        <h2 style="color: #f5d922; margin-bottom: 30px; font-size: 20px;">CADASTRO PAC-L√öPULO</h2>
        <div id="register-loading" class="loading-spinner" style="display: none;"></div>
        <p id="register-error" style="color: #ff4444; min-height: 20px; margin-bottom: 20px;"></p>
        <input
          type="text"
          id="register-name"
          placeholder="Nome Completo"
          class="form-input"
          required
        />
        <input
          type="email"
          id="register-email"
          placeholder="Seu Email"
          class="form-input"
          required
        />
        <input
          type="tel"
          id="register-whatsapp"
          placeholder="Seu WhatsApp (com DDD)"
          class="form-input"
          required
        />

        <input
          type="text"
          id="register-cep"
          placeholder="CEP (somente n√∫meros)"
          class="form-input"
          inputmode="numeric"
          maxlength="9"
          autocomplete="postal-code"
          required
        />


        <!-- Campos Estado e Cidade -->
        <div
          style="
            display: flex;
            gap: 10px;
            margin: 10px 0;
          "
        >
          <select
            id="register-state"
            class="form-input"
            style="flex: 1;"
            required
          >
            <option value="">Estado</option>
          </select>

          <div style="flex: 1; position: relative">
            <input
              list="register-city-list"
              id="register-city-input"
              placeholder="Cidade"
              class="form-input"
              style="width: 100%;"
              required
            />
            <datalist id="register-city-list"></datalist>
          </div>
        </div>

        <input
          type="password"
          id="register-password"
          placeholder="Sua Senha (m√≠n. 6 caracteres)"
          class="form-input"
          minlength="6"
          required
        />
        <input
          type="password"
          id="register-confirm-password"
          placeholder="Confirme sua Senha"
          class="form-input"
          minlength="6"
          required
        />
        <button
          id="register-button"
          class="btn"
          style="width: 100%; margin-top: 20px;"
        >
          Cadastrar
        </button>
        <p style="margin-top: 30px; color: #ccc; font-size: 14px;">
          J√° tem conta?
          <a
            href="#"
            id="show-login-link"
            style="color: #f5d922; cursor: pointer; text-decoration: none; font-weight: bold;"
          >
            Fa√ßa login aqui!
          </a>
        </p>
      </div>
    </div>
    <!-- === FIM TELA DE AUTENTICA√á√ÉO === -->

    <!-- === TELA DE PONTOS === -->
    <div
      id="pontos-screen"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(15px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
        color: #fff;
        font-family: var(--primary-font);
        font-size: 14px;
        animation: fadeIn 0.3s ease-out;
        overflow-y: auto;
        padding: 20px;
      "
    >
      <div style="
        background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
        border: 2px solid #f5d922;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        text-align: center;
      ">
        <h2 style="
          color: #f5d922; 
          font-size: 24px; 
          margin-bottom: 30px;
          text-shadow: 0 0 10px rgba(245, 217, 34, 0.5);
        ">üèÜ SEUS PONTOS</h2>
        
        <div style="
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin-bottom: 30px;
        ">
          <div style="
            background: rgba(245, 217, 34, 0.1);
            border: 1px solid #f5d922;
            border-radius: 12px;
            padding: 20px;
          ">
            <div style="color: #f5d922; font-size: 12px; margin-bottom: 8px;">ACUMULADOS</div>
            <div style="font-size: 20px; font-weight: bold;" id="pontuacao-acumulada">0</div>
          </div>
          <div style="
            background: rgba(245, 217, 34, 0.1);
            border: 1px solid #f5d922;
            border-radius: 12px;
            padding: 20px;
          ">
            <div style="color: #f5d922; font-size: 12px; margin-bottom: 8px;">M√ÅXIMO</div>
            <div style="font-size: 20px; font-weight: bold;" id="pontuacao-maxima">0</div>
          </div>
        </div>

        <h3 style="
          color: #f5d922; 
          margin: 30px 0 20px 0; 
          font-size: 18px;
          text-shadow: 0 0 8px rgba(245, 217, 34, 0.5);
        ">üç∫ RANKING CERVEJEIRO</h3>
        
        <div
          id="ranking-list"
          style="
            width: 100%;
            background: rgba(17, 17, 17, 0.8);
            padding: 20px;
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            scrollbar-width: thin;
            scrollbar-color: #f5d922 #333;
            margin-bottom: 30px;
          "
        >
          <div class="loading-spinner"></div>
        </div>
        
        <button
          id="back-to-game-button"
          class="btn"
          style="width: 100%;"
        >
          üéÆ Voltar ao Jogo
        </button>
      </div>
    </div>
    <!-- === FIM TELA DE PONTOS === -->

    <!-- Sistema de Notifica√ß√µes -->
    <div id="notification-container" style="
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 3000;
      max-width: 300px;
    "></div>

    <!-- Bot√µes de controle -->
    <button id="logout-button" type="button" aria-label="Sair do jogo" title="Sair" style="display: none;" class="btn btn--secondary">Logout</button>
    <button id="pontos-button" type="button" aria-label="Abrir tela de pontos e ranking" title="Pontos" style="display: none;" class="btn btn--secondary">Pontos</button>

    <!-- Canvas do jogo -->
    <canvas id="canvas" tabindex="0" aria-label="√Årea do jogo Pac-L√∫pulo"></canvas>
    <canvas id="atlas" style="display: none"></canvas>

    <!-- Importa scripts do jogo -->
    <script src="pacman.js" defer></script>
    <script src="custom-renderer.js" defer></script>
    <script src="achievements.js" defer></script>
    <script src="mobile-controls.js" defer></script>
    <script src="performance-optimizations.js" defer></script>

    <!-- ========== SISTEMA DE NOTIFICA√á√ïES ========== -->
    <script>
      // Sistema de Notifica√ß√µes
      class NotificationSystem {
        constructor() {
          this.container = document.getElementById('notification-container');
          this.notifications = [];
        }

        show(message, type = 'info', duration = 4000) {
          const notification = document.createElement('div');
          const id = Date.now() + Math.random();
          
          notification.style.cssText = `
            background: ${this.getBackgroundColor(type)};
            color: #fff;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid ${this.getBorderColor(type)};
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-family: inherit;
            font-size: 12px;
            animation: slideInRight 0.3s ease-out;
            cursor: pointer;
            position: relative;
            overflow: hidden;
          `;
          
          notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
              <span>${this.getIcon(type)}</span>
              <span style="flex: 1;">${message}</span>
              <span style="opacity: 0.7; font-size: 16px;">√ó</span>
            </div>
          `;
          
          // Adiciona anima√ß√£o de progresso
          const progressBar = document.createElement('div');
          progressBar.style.cssText = `
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(255,255,255,0.3);
            width: 100%;
            animation: progressBar ${duration}ms linear;
          `;
          notification.appendChild(progressBar);
          
          // Event listeners
          notification.addEventListener('click', () => this.remove(id));
          
          this.container.appendChild(notification);
          this.notifications.push({ id, element: notification });
          
          // Auto remove
          setTimeout(() => this.remove(id), duration);
          
          return id;
        }

        remove(id) {
          const index = this.notifications.findIndex(n => n.id === id);
          if (index !== -1) {
            const notification = this.notifications[index];
            notification.element.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
              if (notification.element.parentNode) {
                notification.element.parentNode.removeChild(notification.element);
              }
            }, 300);
            this.notifications.splice(index, 1);
          }
        }

        getBackgroundColor(type) {
          const colors = {
            success: 'linear-gradient(135deg, #4CAF50, #45a049)',
            error: 'linear-gradient(135deg, #f44336, #d32f2f)',
            warning: 'linear-gradient(135deg, #ff9800, #f57c00)',
            info: 'linear-gradient(135deg, #2196F3, #1976D2)'
          };
          return colors[type] || colors.info;
        }

        getBorderColor(type) {
          const colors = {
            success: '#4CAF50',
            error: '#f44336',
            warning: '#ff9800',
            info: '#2196F3'
          };
          return colors[type] || colors.info;
        }

        getIcon(type) {
          const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
          };
          return icons[type] || icons.info;
        }
      }

      // Adiciona anima√ß√µes CSS
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes progressBar {
          from { width: 100%; }
          to { width: 0%; }
        }
      `;
      document.head.appendChild(style);

      // Inst√¢ncia global
      window.notifications = new NotificationSystem();
    </script>
    <!-- ========== FIM SISTEMA DE NOTIFICA√á√ïES ========== -->

    
    <!-- ========== SCRIPT: CACHE IBGE + AUTOCOMPLETE CEP (VIA CEP) ========== -->
    <script>
      (function() {
        const CACHE_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 days
        const now = () => Date.now();

        function setCache(key, data) {
          try {
            localStorage.setItem(key, JSON.stringify({ts: now(), data}));
          } catch (e) { /* ignore quota */ }
        }
        function getCache(key) {
          try {
            const raw = localStorage.getItem(key);
            if (!raw) return null;
            const obj = JSON.parse(raw);
            if (!obj || !obj.ts || (Date.now() - obj.ts) > CACHE_TTL_MS) return null;
            return obj.data;
          } catch (e) { return null; }
        }

        // Wrap fetch with timeout to avoid blocking
        function fetchWithTimeout(url, ms = 6000) {
          const ctrl = new AbortController();
          const id = setTimeout(() => ctrl.abort(), ms);
          return fetch(url, {signal: ctrl.signal}).finally(() => clearTimeout(id));
        }

        // Enhanced IBGE loaders with localStorage cache (stale-while-revalidate)
        async function getEstados() {
          const CACHE_KEY = 'ibge:estados:v1';
          const cached = getCache(CACHE_KEY);
          // Async refresh in background
          (async () => {
            try {
              const res = await fetchWithTimeout('https://servicodados.ibge.gov.br/api/v1/localidades/estados', 8000);
              if (!res.ok) return;
              const estados = await res.json();
              estados.sort((a,b) => a.sigla.localeCompare(b.sigla));
              setCache(CACHE_KEY, estados);
              // If select is populated only with placeholder, re-render
              const sel = document.getElementById('register-state');
              if (sel && sel.options.length <= 1) renderEstados(estados);
            } catch(e) { /* silent */ }
          })();
          return cached || [];
        }

        async function getCidadesByUFId(ufId) {
          const key = 'ibge:cidades:'+ufId+':v1';
          const cached = getCache(key);
          // Background refresh
          (async () => {
            try {
              const res = await fetchWithTimeout('https://servicodados.ibge.gov.br/api/v1/localidades/estados/'+ufId+'/municipios', 8000);
              if (!res.ok) return;
              const cidades = await res.json();
              setCache(key, cidades);
              const list = document.getElementById('register-city-list');
              const input = document.getElementById('register-city-input');
              if (list && input && input.value.trim() === '' ) renderCidades(cidades);
            } catch(e) { /* noop */ }
          })();
          return cached || [];
        }

        function renderEstados(estados) {
          const selectEstado = document.getElementById('register-state');
          if (!selectEstado) return;
          // Clean previous (except placeholder)
          Array.from(selectEstado.querySelectorAll('option:not([value=""])')).forEach(el => el.remove());
          estados.forEach((estado) => {
            const opt = document.createElement('option');
            opt.value = estado.sigla;
            opt.textContent = `${estado.sigla} - ${estado.nome}`;
            opt.setAttribute('data-id', estado.id);
            selectEstado.appendChild(opt);
          });
        }

        function renderCidades(cidades) {
          const datalist = document.getElementById('register-city-list');
          if (!datalist) return;
          datalist.innerHTML = '';
          cidades.forEach((cidade) => {
            const opt = document.createElement('option');
            opt.value = cidade.nome;
            datalist.appendChild(opt);
          });
        }

        async function carregarEstadosComCache() {
          const estados = await getEstados();
          if (estados && estados.length) renderEstados(estados);
        }

        async function carregarCidadesComCache(ufId) {
          const cidades = await getCidadesByUFId(ufId);
          if (cidades && cidades.length) renderCidades(cidades);
        }

        // CEP autocomplete using ViaCEP
        function sanitizeCEP(value) {
          return (value || '').replace(/\D/g, '').slice(0, 8);
        }

        async function buscaCEP(cep) {
          const clean = sanitizeCEP(cep);
          if (clean.length !== 8) return null;
          const key = 'viacep:'+clean+':v1';
          const cached = getCache(key);
          // background refresh
          (async () => {
            try {
              const r = await fetchWithTimeout('https://viacep.com.br/ws/'+clean+'/json/', 8000);
              if (!r.ok) return;
              const data = await r.json();
              if (data && !data.erro) setCache(key, data);
            } catch(e) { /* ignore */ }
          })();
          return cached || null;
        }

        async function applyCEPAutoComplete(data) {
          if (!data) return;
          // data.uf, data.localidade
          const sel = document.getElementById('register-state');
          const cityInput = document.getElementById('register-city-input');
          if (!sel || !cityInput) return;

          // Select UF by sigla
          const wantedUF = (data.uf || '').toUpperCase();
          let ufId = null;
          for (let i = 0; i < sel.options.length; i++) {
            const opt = sel.options[i];
            if (opt.value === wantedUF) {
              sel.selectedIndex = i;
              ufId = opt.getAttribute('data-id');
              break;
            }
          }
          if (ufId) {
            // Load cities (from cache if possible), then set input value
            const cidades = await getCidadesByUFId(ufId);
            if (data.localidade) {
              cityInput.value = data.localidade;
              carregarCidadesComCache(ufId);
            }
          }
        }

        function setupCEPInput() {
          const cepInput = document.getElementById('register-cep');
          if (!cepInput) return;
          cepInput.addEventListener('input', async function() {
            const clean = sanitizeCEP(cepInput.value);
            if (cepInput.value !== clean) cepInput.value = clean;
            if (clean.length === 8) {
              const data = await buscaCEP(clean);
              if (data) applyCEPAutoComplete(data);
              // never block UI: no await chain beyond this point
            }
          }, {passive: true});
        }

        // Replace initial loaders with cached versions
        document.addEventListener('DOMContentLoaded', function() {
          carregarEstadosComCache();
          const sel = document.getElementById('register-state');
          if (sel) {
            sel.addEventListener('change', function() {
              const idx = sel.selectedIndex;
              const opt = sel.options[idx];
              const ufId = opt ? opt.getAttribute('data-id') : null;
              if (ufId) carregarCidadesComCache(ufId);
            });
          }
          setupCEPInput();
        });

        // Expose for debugging
        window._IBGECache = { getEstados, getCidadesByUFId };

      })();
    </script>

<!-- ========== SCRIPT PARA REMOVER START-SCREEN E EXIBIR AUTH-SCREEN E TOCAR M√öSICA ========== -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const startScreen = document.getElementById("start-screen");
        const authScreen = document.getElementById("auth-screen");
        const bgMusic = document.getElementById("bg-music");

        function handleStartClick() {
          // Toca a m√∫sica de fundo se ainda n√£o estiver tocando
          if (bgMusic.paused) {
            bgMusic.play().catch(function (err) {
              console.warn("Falha ao iniciar m√∫sica automaticamente:", err);
            });
          }
          window.dispatchEvent(new Event('game:cleanup'));
          // Esconde a tela de start
          startScreen.style.display = "none";
          if (firebase && firebase.auth && firebase.auth().currentUser) { authScreen.style.display = 'none'; } else { authScreen.style.display = 'flex'; }
        }

        startScreen.addEventListener("click", handleStartClick);
        startScreen.addEventListener("touchstart", function (e) {
          e.preventDefault();
          handleStartClick();
        });
      });
    </script>
    <!-- ========== FIM DO SCRIPT START/AUTH ========== -->

    <!-- ========== SCRIPT DE AUTENTICA√á√ÉO (LOGIN + CADASTRO) ========== -->
    <script>
      // Refer√™ncias aos elementos do DOM
      const loginForm = document.getElementById("login-form");
      const registerForm = document.getElementById("register-form");
      const loginErrorP = document.getElementById("login-error");
      const registerErrorP = document.getElementById("register-error");
      const showRegisterLink = document.getElementById("show-register-link");
      const showLoginLink = document.getElementById("show-login-link");
      const loginButton = document.getElementById("login-button");
      const registerButton = document.getElementById("register-button");
      const authScreen = document.getElementById("auth-screen");
      const logoutButton = document.getElementById("logout-button");
      const bgMusic = document.getElementById("bg-music");

      // 1) Alternar entre ‚ÄúLogin‚Äù e ‚ÄúCadastro‚Äù
      showRegisterLink.addEventListener("click", function (e) {
        e.preventDefault();
        loginForm.style.display = "none";
        registerForm.style.display = "block";
        loginErrorP.textContent = "";
      });
      showLoginLink.addEventListener("click", function (e) {
        e.preventDefault();
        registerForm.style.display = "none";
        loginForm.style.display = "block";
        registerErrorP.textContent = "";
      });

      // 2) Fun√ß√£o auxiliar para mostrar erro
      function exibirErro(elementoP, mensagem) {
        elementoP.textContent = mensagem;
      }

      // 3) LOGIN
      loginButton.addEventListener("click", function (e) {
  e.preventDefault();
  const emailEl = document.getElementById("login-email");
  const passwordEl = document.getElementById("login-password");
  const email = (emailEl.value || "").trim();
  const password = passwordEl.value || "";
  const loadingEl = document.getElementById("login-loading");

  if (!email || !password) {
    exibirErro(loginErrorP, "Preencha email e senha.");
    notifications?.show("Preencha todos os campos obrigat√≥rios", "warning");
    return;
  }

  // Valida√ß√£o simples de email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    exibirErro(loginErrorP, "Email inv√°lido.");
    notifications?.show("Por favor, insira um email v√°lido", "warning");
    return;
  }

  exibirErro(loginErrorP, "");
  loadingEl.style.display = "block";
  loginButton.disabled = true;
  loginButton.textContent = "Entrando...";

  firebase.auth()
    .signInWithEmailAndPassword(email, password)
    .then(() => {
      notifications?.show("Login realizado com sucesso! üéÆ", "success");
      const bgMusic = document.getElementById("bg-music");
            bgMusic.pause(); bgMusic.currentTime = 0;
      try { window.__gameRunning = true; } catch(e){}
      try { window.primeGameAudio && window.primeGameAudio(); } catch(e){}
      iniciarJogo(); // mant√©m o fluxo atual
    })
    .catch((erro) => {
      let mensagem = "Erro no acesso. Verifique seu Email e Senha.";
      if (erro.code === 'auth/user-not-found') mensagem = "Usu√°rio n√£o encontrado. Verifique seu email.";
      else if (erro.code === 'auth/wrong-password') mensagem = "Senha incorreta. Tente novamente.";
      else if (erro.code === 'auth/too-many-requests') mensagem = "Muitas tentativas. Tente novamente em alguns minutos.";
      exibirErro(loginErrorP, mensagem);
      notifications?.show(mensagem, "error");
      console.error("Erro no login:", erro);
    })
    .finally(() => {
      loadingEl.style.display = "none";
      loginButton.disabled = false;
      loginButton.textContent = "Entrar";
          });
      });

      // 4) CADASTRO
      registerButton.addEventListener("click", function (e) {
  e.preventDefault();

  // Elementos
  const nomeEl       = document.getElementById("register-name");
  const emailEl      = document.getElementById("register-email");
  const whatsappEl   = document.getElementById("register-whatsapp");
  const estadoEl     = document.getElementById("register-state");
  const cidadeEl     = document.getElementById("register-city-input");
  const passEl       = document.getElementById("register-password");
  const confirmEl    = document.getElementById("register-confirm-password");
  const cepEl        = document.getElementById("register-cep");
  const loadingEl    = document.getElementById("register-loading");

  // Valores brutos
  const nomeRaw      = nomeEl.value || "";
  const emailRaw     = emailEl.value || "";
  const whatsappRaw  = whatsappEl.value || "";
  const estado       = estadoEl.value || "";
  const cidadeRaw    = cidadeEl.value || "";
  const password     = passEl.value || "";
  const confirmPass  = confirmEl.value || "";
  const cepValue     = (cepEl.value || "").replace(/\D/g, ""); // s√≥ d√≠gitos

  // Sanitiza√ß√£o (mant√©m compatibilidade com seu gameOptimizations, se existir)
  const sanitize = (s) => (s || "").trim();
  const nome     = window.gameOptimizations?.sanitizeInput ? window.gameOptimizations.sanitizeInput(nomeRaw) : sanitize(nomeRaw);
  const email    = window.gameOptimizations?.sanitizeInput ? window.gameOptimizations.sanitizeInput(emailRaw) : sanitize(emailRaw);
  const cidade   = window.gameOptimizations?.sanitizeInput ? window.gameOptimizations.sanitizeInput(cidadeRaw) : sanitize(cidadeRaw);
  const whatsapp = window.gameOptimizations?.sanitizeInput ? window.gameOptimizations.sanitizeInput(whatsappRaw) : sanitize(whatsappRaw);
  const cleanWhatsapp = whatsapp.replace(/\D/g, "");

  // Obrigat√≥rios
  if (!nome || !email || !cleanWhatsapp || !estado || !cidade || !password || !confirmPass || !cepValue) {
    exibirErro(registerErrorP, "Preencha todos os campos obrigat√≥rios (incluindo CEP).");
    notifications?.show("Todos os campos s√£o obrigat√≥rios", "warning");
    return;
  }

  // CEP: 8 d√≠gitos
  if (!/^\d{8}$/.test(cepValue)) {
    exibirErro(registerErrorP, "CEP inv√°lido. Use 8 d√≠gitos (ex.: 01311200).");
    notifications?.show("CEP inv√°lido. Use 8 d√≠gitos.", "warning");
    return;
  }

  // Nome: pelo menos 2 palavras
  if (nome.split(' ').filter(Boolean).length < 2) {
    exibirErro(registerErrorP, "Digite seu nome completo.");
    notifications?.show("Por favor, digite seu nome completo", "warning");
    return;
  }

  // Email v√°lido
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    exibirErro(registerErrorP, "Email inv√°lido.");
    notifications?.show("Por favor, insira um email v√°lido", "warning");
    return;
  }

  // WhatsApp: 10 ou 11 d√≠gitos
  if (cleanWhatsapp.length < 10 || cleanWhatsapp.length > 11) {
    exibirErro(registerErrorP, "WhatsApp deve ter 10 ou 11 d√≠gitos.");
    notifications?.show("WhatsApp inv√°lido. Use formato: (11) 99999-9999", "warning");
    return;
  }

  // Senha
  if (password.length < 6) {
    exibirErro(registerErrorP, "Senha deve ter pelo menos 6 caracteres.");
    notifications?.show("Senha muito curta. M√≠nimo 6 caracteres", "warning");
    return;
  }
  if (password !== confirmPass) {
    exibirErro(registerErrorP, "As senhas n√£o coincidem.");
    notifications?.show("As senhas n√£o coincidem", "warning");
    return;
  }

  exibirErro(registerErrorP, "");
  loadingEl.style.display = "block";
  registerButton.disabled = true;
  registerButton.textContent = "Cadastrando...";

  // Cria usu√°rio e salva no Firestore (inclui CEP)
  firebase.auth()
    .createUserWithEmailAndPassword(email, password)
    .then((cred) => {
      const userId = cred.user.uid;
      notifications?.show("Conta criada! Salvando dados...", "info");

      return firebase.firestore()
        .collection("players")
        .doc(userId)
        .set({
          email: email,
          nome: nome,
          cep: cepValue,              // <<<<<< SALVA O CEP AQUI
          whatsapp: cleanWhatsapp,
          estado: estado,
          cidade: cidade,
          dataCadastro: firebase.firestore.FieldValue.serverTimestamp(),
          nivelMax: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          pontuacaoAcumulada: 0,
          pontuacaoMaxima: 0,
          quantidadePlays: 0
        });
    })
    .then(() => {
      notifications?.show("Cadastro realizado com sucesso! üéâ", "success");
      // Faz login e inicia o jogo (usa rotina existente)
      return firebase.auth().signInWithEmailAndPassword(email, password);
    })
    .then(() => {
      const bgMusic = document.getElementById("bg-music");
            bgMusic.pause(); bgMusic.currentTime = 0;
      try { window.__gameRunning = true; } catch(e){}
      try { window.primeGameAudio && window.primeGameAudio(); } catch(e){}
      iniciarJogo();
    })
    .catch((erro) => {
      let mensagem = erro.message;
      if (erro.code === 'auth/email-already-in-use')  mensagem = "Este email j√° est√° em uso. Tente fazer login.";
      else if (erro.code === 'auth/weak-password')    mensagem = "Senha muito fraca. Use pelo menos 6 caracteres.";
      else if (erro.code === 'auth/invalid-email')     mensagem = "Email inv√°lido.";
      exibirErro(registerErrorP, mensagem);
      notifications?.show(mensagem, "error");
      console.error("Erro no cadastro:", erro);
    })
    .finally(() => {
      loadingEl.style.display = "none";
      registerButton.disabled = false;
      registerButton.textContent = "Cadastrar";
          });
      });

      // 5) Verifica estado de autentica√ß√£o ao carregar
      firebase.auth().onAuthStateChanged(function (user) {
        if (user) {
          // Se j√° estivesse logado, pula direto para o jogo
          authScreen.style.display = "none";
          logoutButton.style.display = "block";
          pontosButton.style.display = "block";
        } else {
          // Se n√£o estiver logado, mostra formul√°rio de login
          if (firebase && firebase.auth && firebase.auth().currentUser) { authScreen.style.display = 'none'; } else { authScreen.style.display = 'flex'; }
          loginForm.style.display = "block";
          registerForm.style.display = "none";
          loginErrorP.textContent = "";
          registerErrorP.textContent = "";
          logoutButton.style.display = "none";
        }
      });

      // 6) LOGOUT
      logoutButton.addEventListener("click", function () {
        firebase
          .auth()
          .signOut()
          .then(() => {
            // Ao sair, recarrega a p√°gina para exibir tela de autentica√ß√£o
            location.reload();
          });
      });

      // 7) PONTOS
      const pontosButton = document.getElementById("pontos-button");
      const pontosScreen = document.getElementById("pontos-screen");
      const backToGameButton = document.getElementById("back-to-game-button");
      const pontuacaoAcumuladaSpan = document.getElementById(
        "pontuacao-acumulada",
      );
      const pontuacaoMaximaSpan = document.getElementById("pontuacao-maxima");
      const rankingListDiv = document.getElementById("ranking-list");

      pontosButton.addEventListener("click", async function () {
        // Pausa o jogo e √°udios como no bot√£o MENU
        try { window.dispatchEvent(new Event('gameaudio-prime-request')); } catch(e){}
        try { window.__pointsOverlayOpen = true; } catch(e){}
        pontosScreen.style.display = "flex";
        document.getElementById("canvas").style.display = "none";
        logoutButton.style.display = "none";
        pontosButton.style.display = "none";

        // Detec√ß√£o mobile aprimorada
        const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (window.innerWidth <= 768 && 'ontouchstart' in window);
        
        console.log("üì± Device type:", isMobile ? 'Mobile' : 'Desktop');
        console.log("üì± Screen width:", window.innerWidth);

        // Fetch user stats com l√≥gica mobile aprimorada
        const user = firebase.auth().currentUser;
        if (user) {
          console.log("üë§ Fetching user stats for user:", user.uid);
          console.log("Device type:", /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop');
          try {
            const playerDoc = await db
              .collection("players")
              .doc(user.uid)
              .get();
            if (playerDoc.exists) {
              const data = playerDoc.data();
              console.log("üìä User data fetched:", data);
              console.log("üîë Data keys:", Object.keys(data));
              
              // L√≥gica definitiva para estruturas de dados
              let pontuacaoAcumulada = 0;
              let pontuacaoMaxima = 0;
              
              // Prioridade 1: Estrutura playersAvatares
              if (data.playersAvatares && typeof data.playersAvatares === 'object') {
                const stats = data.playersAvatares;
                pontuacaoAcumulada = stats.pontuacaoAcumulada || 0;
                pontuacaoMaxima = stats.pontuacaoMaxima || 0;
                console.log("‚úÖ Using playersAvatares structure");
              }
              // Prioridade 2: Estrutura no n√≠vel raiz
              else if (data.pontuacaoAcumulada !== undefined || data.pontuacaoMaxima !== undefined) {
                pontuacaoAcumulada = data.pontuacaoAcumulada || 0;
                pontuacaoMaxima = data.pontuacaoMaxima || 0;
                console.log("‚úÖ Using root level structure");
              }
              // Prioridade 3: Fallbacks alternativos
              else {
                pontuacaoAcumulada = data.totalScore || data.score || 0;
                pontuacaoMaxima = data.maxScore || data.highScore || data.bestScore || 0;
                console.log("‚úÖ Using fallback structure");
              }
              
              console.log("üìä Final stats - Acumulada:", pontuacaoAcumulada, "M√°xima:", pontuacaoMaxima);
              
              // Atualiza interface com garantia de exibi√ß√£o
              pontuacaoAcumuladaSpan.textContent = pontuacaoAcumulada;
              pontuacaoMaximaSpan.textContent = pontuacaoMaxima;
              
              // Log espec√≠fico para mobile
              if (isMobile) {
                console.log("üì± Mobile stats updated - Acumulada:", pontuacaoAcumuladaSpan.textContent, "M√°xima:", pontuacaoMaximaSpan.textContent);
              }
            } else {
              console.log("User document does not exist.");
              pontuacaoAcumuladaSpan.textContent = 0;
              pontuacaoMaximaSpan.textContent = 0;
            }
          } catch (error) {
            console.error("Error fetching user stats:", error);
            pontuacaoAcumuladaSpan.textContent = 0;
            pontuacaoMaximaSpan.textContent = 0;
          }
        } else {
          console.log("No user logged in.");
          pontuacaoAcumuladaSpan.textContent = 0;
          pontuacaoMaximaSpan.textContent = 0;
        }

        // Fetch ranking com filtragem rigorosa
        rankingListDiv.innerHTML = ""; // Clear previous ranking
        console.log("üèÜ Fetching ranking...");
        try {
          // Get all players and sort client-side to avoid Firestore index requirements
          const rankingSnapshot = await db.collection("players").get();

          console.log("üèÜ Ranking snapshot size:", rankingSnapshot.size);
          if (rankingSnapshot.empty) {
            rankingListDiv.innerHTML =
              "<p style='font-size: 12px;'>Nenhum jogador no ranking ainda.</p>";
          } else {
            // Filtragem rigorosa de dados v√°lidos
            const players = [];
            rankingSnapshot.forEach((doc) => {
              const data = doc.data();
              const docId = doc.id;
              
              // Ignora documentos de teste ou inv√°lidos
              if (!data.nome || typeof data.nome !== 'string' || data.nome.trim() === '') {
                console.log("üö´ Ignorando documento sem nome v√°lido:", docId);
                return;
              }
              
              // Ignora nomes de teste conhecidos
              const nomeNormalizado = data.nome.trim().toUpperCase();
              const nomesIgnorados = ['NOVO', 'BETO', 'TEST', 'TESTE', 'ADMIN', 'DEBUG'];
              if (nomesIgnorados.includes(nomeNormalizado)) {
                console.log("üö´ Ignorando nome de teste:", data.nome);
                return;
              }
              
              // Extrai pontua√ß√£o m√°xima com m√∫ltiplas tentativas
              let pontuacaoMaxima = 0;
              if (data.playersAvatares && typeof data.playersAvatares === 'object') {
                pontuacaoMaxima = data.playersAvatares.pontuacaoMaxima || 0;
              } else {
                pontuacaoMaxima = data.pontuacaoMaxima || data.maxScore || data.highScore || data.bestScore || 0;
              }
              
              // S√≥ inclui jogadores com pontua√ß√£o v√°lida
              if (pontuacaoMaxima > 0 && pontuacaoMaxima < 1000000) { // Limite m√°ximo razo√°vel
                players.push({
                  nome: data.nome.trim(),
                  pontuacaoMaxima: pontuacaoMaxima,
                  docId: docId
                });
                console.log("‚úÖ Jogador v√°lido adicionado:", data.nome, "-", pontuacaoMaxima, "pts");
              } else {
                console.log("üö´ Ignorando jogador com pontua√ß√£o inv√°lida:", data.nome, "-", pontuacaoMaxima);
              }
            });

            // Sort by score descending and take top 100
            players.sort((a, b) => b.pontuacaoMaxima - a.pontuacaoMaxima);
            const top100 = players.slice(0, 100);

            console.log("üèÜ Top players found:", top100.length);

            if (top100.length === 0) {
              rankingListDiv.innerHTML =
                "<p style='font-size: 12px;'>Nenhum jogador com pontua√ß√£o v√°lida no ranking ainda.</p>";
            } else {
              top100.forEach((player, index) => {
                const rankingItem = document.createElement("p");
                rankingItem.style.margin = "5px 0";
                rankingItem.style.padding = "5px";
                rankingItem.style.borderBottom = "1px solid #333";
                rankingItem.style.fontSize = "12px";
                rankingItem.style.color = "#fff"; // Cor branca padr√£o
                rankingItem.textContent = `${index + 1}. ${player.nome} - ${player.pontuacaoMaxima} pts`;
                rankingListDiv.appendChild(rankingItem);
                
                console.log(`üèÜ ${index + 1}. ${player.nome} - ${player.pontuacaoMaxima} pts`);
              });
            }
          }
        } catch (error) {
          console.error("Error fetching ranking:", error);
          if (error.code === "permission-denied") {
            rankingListDiv.innerHTML =
              "<p style='color: #f5d922; font-size: 12px;'>Ranking temporariamente indispon√≠vel. Configurando permiss√µes...</p>";
          } else {
            rankingListDiv.innerHTML = "<p style='font-size: 12px;'>Erro ao carregar ranking.</p>";
          }
        }
      });

      backToGameButton.addEventListener("click", function () {
        try { window.__pointsOverlayOpen = false; } catch(e){}
pontosScreen.style.display = "none";
        document.getElementById("canvas").style.display = "block";
        logoutButton.style.display = "block";
        pontosButton.style.display = "block";
      });
    </script>

    <script>
      function updateStatsFirestore(score, level) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userId = user.uid;
  const playerRef = firebase.firestore().collection("players").doc(userId);

  playerRef.get().then(async (doc) => {
    if (!doc.exists) return;

    const data = doc.data();
    const prevNivelMax = data.nivelMax || 0;
    const prevPontAcum = data.pontuacaoAcumulada || 0;
    const prevPontMax  = data.pontuacaoMaxima || 0;
    const prevQtyPlays = data.quantidadePlays || 0;

    const newNivelMax = Math.max(level, prevNivelMax);
    const newPontAcum = prevPontAcum + score;
    const newPontMax  = Math.max(score, prevPontMax);
    const newQtyPlays = prevQtyPlays + 1;

    const gameSession = {
      score, level,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      duration: Date.now() - (window.gameStartTime || Date.now()),
      isNewRecord: score > prevPontMax
    };

    const updateData = {
      dataUltimoPlay: firebase.firestore.FieldValue.serverTimestamp(),
      nivelMax: newNivelMax,
      pontuacaoAcumulada: newPontAcum,
      pontuacaoMaxima: newPontMax,
      quantidadePlays: newQtyPlays,
      lastGameSession: gameSession
    };

    const sessionsRef = firebase.firestore()
      .collection('players').doc(userId).collection('sessions');

    await sessionsRef.add(gameSession);
    await playerRef.update(updateData);

    if (window.achievementSystem) {
      await window.achievementSystem.checkAchievements(
        { pontuacaoMaxima: newPontMax, pontuacaoAcumulada: newPontAcum, quantidadePlays: newQtyPlays, nivelMax: newNivelMax },
        { currentScore: score, currentLevel: level, isNewRecord: score > prevPontMax }
      );
    }

    if (score > prevPontMax && window.notifications) {
      window.notifications.show(`üéâ Novo recorde pessoal: ${score} pontos!`, 'success', 5000);
    }
  }).catch(err => {
    console.error('‚ùå Erro ao atualizar estat√≠sticas:', err);
    window.notifications?.show('Erro ao salvar pontua√ß√£o. Verifique sua conex√£o.', 'error');
          }
        });
      }

      // Fun√ß√£o para iniciar tracking de sess√£o
      function startGameSession() {
        window.gameStartTime = Date.now();
      }

      // Fun√ß√£o para analytics de gameplay
      function trackGameplayEvent(eventType, data = {}) {
        const user = firebase.auth().currentUser;
        if (!user) return;

        const eventData = {
          type: eventType,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          userId: user.uid,
          ...data
        };

        // Salva evento na cole√ß√£o de analytics
        firebase.firestore()
          .collection('analytics')
          .add(eventData)
          .catch(err => console.error('Erro ao salvar analytics:', err));
      }
    </script>

    <script>
      function iniciarJogo() {
        try { var __b = document.getElementById('bg-music'); if(__b){ __b.pause(); __b.currentTime = 0; } } catch(e){}
try {
          document.getElementById("auth-screen").style.display = "none";
          document.getElementById("logout-button").style.display = "block";
          document.getElementById("pontos-button").style.display = "block";

          // Inicia tracking da sess√£o de jogo
          startGameSession();
          
          // Track evento de in√≠cio de jogo
          trackGameplayEvent('game_start', {
            timestamp: new Date().toISOString()
          });

          // Aguarda o executive estar dispon√≠vel com timeout de seguran√ßa
          let tentativas = 0;
          const maxTentativas = 50; // 5 segundos m√°ximo
          const esperar = setInterval(() => {
            tentativas++;
            if (
              typeof executive !== "undefined" &&
              typeof executive.init === "function" &&
              typeof switchState === "function" &&
              typeof homeState !== "undefined"
            ) {
              clearInterval(esperar);
              executive.init();
              switchState(homeState);
              
              // Notifica√ß√£o de boas-vindas
              if (window.notifications) {
                window.notifications.show(
                  "üéÆ Bem-vindo ao Pac-L√∫pulo! Colete l√∫pulos e evite os fantasmas!",
                  "info",
                  4000
                );
              }
            } else if (tentativas >= maxTentativas) {
              clearInterval(esperar);
              console.error("Timeout: N√£o foi poss√≠vel inicializar o jogo");
              // Removido aviso de erro desnecess√°rio - o jogo funciona normalmente
            }
          }, 100);
        } catch (err) {
          console.error("Erro ao iniciar o jogo:", err);
          // Removido aviso de erro desnecess√°rio - o jogo funciona normalmente
        }
      }
    </script>
  
    <!-- ========== SERVICE WORKER REGISTRATION (versioned cache) ========== -->
    <script>
      (function(){
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js')
              .then(function(reg) {
                console.log('[SW] Registered:', reg.scope || reg);
              })
              .catch(function(err){ console.warn('[SW] Registration failed:', err); });
          });
        }
      })();
    </script>

  <script src="audio-unlock.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  try {
    const startScreen = document.getElementById("start-screen");
    const authScreen  = document.getElementById("auth-screen");
    const bgMusic     = document.getElementById("bg-music");
    function __pp_handleStartClick() {
      try {
        if (bgMusic && bgMusic.paused) {
          bgMusic.play().catch(function (err) { console.warn("Falha ao iniciar m√∫sica:", err); });
        }
        window.dispatchEvent(new Event('game:cleanup'));
        if (startScreen) startScreen.style.display = "none";
        if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
          if (authScreen) authScreen.style.display = 'none';
        } else {
          if (authScreen) authScreen.style.display = 'flex';
        }
      } catch(e){}
    }
    if (startScreen) {
      startScreen.addEventListener("click", __pp_handleStartClick);
      startScreen.addEventListener("touchstart", function(e){ e.preventDefault(); __pp_handleStartClick(); });
    }
  } catch(e){}
});
</script>
</body>
</html>
